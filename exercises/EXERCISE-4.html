

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Exercise 4: Enabling ONOS built-in services &mdash; Software-Defined Networks: A Systems Approach Version 0.3-dev documentation</title>
  

  
  
    <link rel="shortcut icon" href="../static/bridge.ico"/>
  
  
  

  
  <script type="text/javascript" src="../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../static/documentation_options.js"></script>
        <script type="text/javascript" src="../static/jquery.js"></script>
        <script type="text/javascript" src="../static/underscore.js"></script>
        <script type="text/javascript" src="../static/doctools.js"></script>
        <script type="text/javascript" src="../static/language_data.js"></script>
    
    <script type="text/javascript" src="../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../static/css/rtd_theme_mods.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Exercise 5: IPv6 routing" href="EXERCISE-5.html" />
    <link rel="prev" title="Exercise 3: Using ONOS as the control plane" href="EXERCISE-3.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Software-Defined Networks: A Systems Approach
          

          
          </a>

          
            
            
              <div class="version">
                Version 0.3-dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Chapter 1:  Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uses.html">Chapter 2:  Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">Chapter 3:  Basic Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../switch.html">Chapter 4:  White-Box Switches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stratum.html">Chapter 5:  Switch OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onos.html">Chapter 6:  Network OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trellis.html">Chapter 7:  Leaf-Spine Fabric</a></li>
<li class="toctree-l1"><a class="reference internal" href="../future.html">Chapter 8:  Future of SDN</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../exercises.html">Programming Exercises</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-1.html">Exercise 1: P4Runtime basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-2.html">Exercise 2: Yang, OpenConfig, and gNMI basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-3.html">Exercise 3: Using ONOS as the control plane</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Exercise 4: Enabling ONOS built-in services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#controller-packet-i-o-with-p4runtime">Controller packet I/O with P4Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="#part-1-enable-packet-i-o-and-verify-link-discovery">Part 1: enable packet I/O and verify link discovery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#modify-p4-program">1. Modify P4 program</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-ptf-tests">2. Run PTF tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-onos-pipeline-interpreter">3. Modify ONOS pipeline interpreter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restart-onos">4. Restart ONOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#load-updated-app-and-register-pipeconf">5. Load updated app and register pipeconf</a></li>
<li class="toctree-l4"><a class="reference internal" href="#push-netcfg-to-onos-to-trigger-device-and-link-discovery">6. Push netcfg to ONOS to trigger device and link discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualize-links-on-the-onos-ui">7. Visualize links on the ONOS UI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#part-2-host-discovery-l2-bridging">Part 2: Host discovery &amp; L2 bridging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview-our-implementation-of-l2-bridging">Overview: our implementation of L2 bridging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-l2bridgingcomponent-and-reload-the-app">1. Enable L2BridgingComponent and reload the app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#examine-flow-rules-and-groups">2. Examine flow rules and groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-l2-bridging-on-mininet">3. Test L2 bridging on Mininet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualize-hosts-on-the-onos-cli-and-web-ui">4. Visualize hosts on the ONOS CLI and web UI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#congratulations">Congratulations!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-5.html">Exercise 5: IPv6 routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-6.html">Exercise 6: Segment Routing v6 (SRv6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-7.html">Exercise 7: Trellis Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-8.html">Exercise 8: GTP termination with fabric.p4</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">About This Book</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Software-Defined Networks: A Systems Approach</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../exercises.html">Programming Exercises</a> &raquo;</li>
        
      <li>Exercise 4: Enabling ONOS built-in services</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/exercises/EXERCISE-4.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="EXERCISE-5.html" class="btn btn-neutral float-right" title="Exercise 5: IPv6 routing" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="EXERCISE-3.html" class="btn btn-neutral float-left" title="Exercise 3: Using ONOS as the control plane" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="exercise-4-enabling-onos-built-in-services">
<h1>Exercise 4: Enabling ONOS built-in services<a class="headerlink" href="#exercise-4-enabling-onos-built-in-services" title="Permalink to this headline">¶</a></h1>
<p>In this exercise, you will have to integrate ONOS built-in services for link and
host discovery with your P4 program. Such built-in services are based on the
ability of switches to send data plane packets to the controller (packet-in) and
vice versa (packet-out).</p>
<p>To make this work with your P4 program, you will need to apply simple changes to
the starter P4 code, validate the P4 changes using PTF-based data plane unit
tests, and finally, apply changes to the pipeconf Java implementation to enable
ONOS’s built-in apps to use packet-in/out via P4Runtime.</p>
<p>The exercise has two parts:</p>
<ol class="simple">
<li>Enable packet I/O and verify link discovery</li>
<li>Host discovery &amp; L2 bridging</li>
</ol>
<p>But first, let’s review how controller packet I/O works with P4Runtime.</p>
<div class="section" id="controller-packet-i-o-with-p4runtime">
<h2>Controller packet I/O with P4Runtime<a class="headerlink" href="#controller-packet-i-o-with-p4runtime" title="Permalink to this headline">¶</a></h2>
<p>The P4 program under <a class="reference external" href="p4src/main.p4">p4src/main.p4</a> provides support for
carrying arbitrary metadata in P4Runtime <code class="docutils literal notranslate"><span class="pre">PacketIn</span></code> and <code class="docutils literal notranslate"><span class="pre">PacketOut</span></code> messages.
Two special headers are defined and annotated with the standard P4 annotation
<code class="docutils literal notranslate"><span class="pre">&#64;controller_header</span></code>:</p>
<div class="highlight-p4 notranslate"><div class="highlight"><pre><span></span>@controller_header(&quot;packet_in&quot;)
header cpu_in_header_t {
    port_num_t ingress_port;
    bit&lt;7&gt; _pad;
}

@controller_header(&quot;packet_out&quot;)
header cpu_out_header_t {
    port_num_t egress_port;
    bit&lt;7&gt; _pad;
}
</pre></div>
</div>
<p>These headers are used to carry the original switch ingress port of a packet-in,
and to specify the intended output port for a packet-out.</p>
<p>When the P4Runtime agent in Stratum receives a packet from the switch CPU port,
it expects to find the <code class="docutils literal notranslate"><span class="pre">cpu_in_header_t</span></code> header as the first one in the frame.
Indeed, it looks at the <code class="docutils literal notranslate"><span class="pre">controller_packet_metadata</span></code> part of the P4Info file to
determine the number of bits to strip at the beginning of the frame and to
populate the corresponding metadata field of the <code class="docutils literal notranslate"><span class="pre">PacketIn</span></code> message, including
the ingress port as in this case.</p>
<p>Similarly, when Stratum receives a P4Runtime <code class="docutils literal notranslate"><span class="pre">PacketOut</span></code> message, it uses the
values found in the <code class="docutils literal notranslate"><span class="pre">PacketOut</span></code>’s metadata fields to serialize and prepend a
<code class="docutils literal notranslate"><span class="pre">cpu_out_header_t</span></code> to the frame before feeding it to the pipeline parser.</p>
</div>
<div class="section" id="part-1-enable-packet-i-o-and-verify-link-discovery">
<h2>Part 1: enable packet I/O and verify link discovery<a class="headerlink" href="#part-1-enable-packet-i-o-and-verify-link-discovery" title="Permalink to this headline">¶</a></h2>
<div class="section" id="modify-p4-program">
<h3>1. Modify P4 program<a class="headerlink" href="#modify-p4-program" title="Permalink to this headline">¶</a></h3>
<p>The P4 starter code already provides support for the following capabilities:</p>
<ul class="simple">
<li>Parse the <code class="docutils literal notranslate"><span class="pre">cpu_out</span></code> header (if the ingress port is the CPU one)</li>
<li>Emit the <code class="docutils literal notranslate"><span class="pre">cpu_in</span></code> header as the first one in the deparser</li>
<li>Provide an ACL table with ternary match fields and an action to send or clone
packets to the CPU port (used to generate a packet-ins)</li>
</ul>
<p>Something is missing to provide complete packet-in/out support, and you have to
modify the P4 program to implement it:</p>
<ol class="simple">
<li>Open <code class="docutils literal notranslate"><span class="pre">p4src/main.p4</span></code>;</li>
<li>Modify the code where requested (look for <code class="docutils literal notranslate"><span class="pre">TODO</span> <span class="pre">EXERCISE</span> <span class="pre">4</span></code>);</li>
<li>Compile the modified P4 program using the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">p4-build</span></code> command. Make sure
to address any compiler errors before continuing.</li>
</ol>
<p>At this point, our P4 pipeline should be ready for testing.</p>
</div>
<div class="section" id="run-ptf-tests">
<h3>2. Run PTF tests<a class="headerlink" href="#run-ptf-tests" title="Permalink to this headline">¶</a></h3>
<p>Before starting ONOS, let’s make sure the P4 changes work as expected by
running some PTF tests. But first, you need to apply a few simple changes to the
test case implementation.</p>
<p>Open file <code class="docutils literal notranslate"><span class="pre">ptf/tests/packetio.py</span></code> and modify wherever requested (look for <code class="docutils literal notranslate"><span class="pre">TODO</span> <span class="pre">EXERCISE</span> <span class="pre">4</span></code>). This test file provides two test cases: one for packet-in and
one for packet-out. In both test cases, you will have to modify the implementation to
use the same name for P4Runtime entities as specified in the P4Info file
obtained after compiling the P4 program (<code class="docutils literal notranslate"><span class="pre">p4src/build/p4info.txt</span></code>).</p>
<p>To run all the tests for this exercise:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">packetio</span>
</pre></div>
</div>
<p>This command will run all tests in the <code class="docutils literal notranslate"><span class="pre">packetio</span></code> group (i.e. the content of
<code class="docutils literal notranslate"><span class="pre">ptf/tests/packetio.py</span></code>). To run a specific test case you can use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=&lt;</span><span class="n">PYTHON</span> <span class="n">MODULE</span><span class="o">&gt;.&lt;</span><span class="n">TEST</span> <span class="n">CLASS</span> <span class="n">NAME</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">packetio</span><span class="o">.</span><span class="n">PacketOutTest</span>
</pre></div>
</div>
<div class="section" id="check-for-regressions">
<h4>Check for regressions<a class="headerlink" href="#check-for-regressions" title="Permalink to this headline">¶</a></h4>
<p>To make sures the new changes are not breaking other features, make sure to run
tests for L2 bridging support.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">bridging</span>
</pre></div>
</div>
<p>If all tests succeed, congratulations! You can move to the next step.</p>
</div>
<div class="section" id="how-to-debug-failing-tests">
<h4>How to debug failing tests?<a class="headerlink" href="#how-to-debug-failing-tests" title="Permalink to this headline">¶</a></h4>
<p>When running PTF tests, multiple files are produced that you can use to spot bugs:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">ptf/stratum_bmv2.log</span></code>: BMv2 log with trace level (showing tables matched and
other info for each packet)</li>
<li><code class="docutils literal notranslate"><span class="pre">ptf/p4rt_write.log</span></code>: Log of all P4Runtime Write requests</li>
<li><code class="docutils literal notranslate"><span class="pre">ptf/ptf.pcap</span></code>: PCAP file with all packets sent and received during tests
(the tutorial VM comes with Wireshark for easier visualization)</li>
<li><code class="docutils literal notranslate"><span class="pre">ptf/ptf.log</span></code>: PTF log of all packet operations (sent and received)</li>
</ul>
</div>
</div>
<div class="section" id="modify-onos-pipeline-interpreter">
<h3>3. Modify ONOS pipeline interpreter<a class="headerlink" href="#modify-onos-pipeline-interpreter" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">PipelineInterpreter</span></code> is the ONOS driver behavior used to map the ONOS
representation of packet-in/out to one that is consistent with your P4
pipeline (along with other similar mappings).</p>
<p>Specifically, to use services like link and host discovery, ONOS built-in apps
need to be able to set the output port of a packet-out and access the original
ingress port of a packet-in.</p>
<p>In the following, you will be asked to apply a few simple changes to the
<code class="docutils literal notranslate"><span class="pre">PipelineInterpreter</span></code> implementation:</p>
<ol class="simple">
<li>Open file:
<code class="docutils literal notranslate"><span class="pre">app/src/main/java/org/onosproject/ngsdn/tutorial/pipeconf/InterpreterImpl.java</span></code></li>
<li>Modify wherever requested (look for <code class="docutils literal notranslate"><span class="pre">TODO</span> <span class="pre">EXERCISE</span> <span class="pre">4</span></code>), specifically:<ul>
<li>Look for a method named <code class="docutils literal notranslate"><span class="pre">buildPacketOut</span></code>, modify the implementation to use the
same name of the <strong>egress port</strong> metadata field for the <code class="docutils literal notranslate"><span class="pre">packet_out</span></code>
header as specified in the P4Info file.</li>
<li>Look for method <code class="docutils literal notranslate"><span class="pre">mapInboundPacket</span></code>, modify the implementation to use the
same name of the <strong>ingress port</strong> metadata field for the <code class="docutils literal notranslate"><span class="pre">packet_in</span></code>
header as specified in the P4Info file.</li>
</ul>
</li>
<li>Build ONOS app (including the pipeconf) with the command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">app-build</span></code>.</li>
</ol>
<p>The P4 compiler outputs (<code class="docutils literal notranslate"><span class="pre">bmv2.json</span></code> and <code class="docutils literal notranslate"><span class="pre">p4info.txt</span></code>) are copied in the app
resource folder (<code class="docutils literal notranslate"><span class="pre">app/src/main/resources</span></code>) and will be included in the ONOS app
binary. The copy that gets included in the ONOS app will be the one that gets
deployed by ONOS to the device after the connection is initiated.</p>
</div>
<div class="section" id="restart-onos">
<h3>4. Restart ONOS<a class="headerlink" href="#restart-onos" title="Permalink to this headline">¶</a></h3>
<p><strong>Note:</strong> ONOS should be already running, and in theory, there should be no need
to restart it. However, while ONOS supports reloading the pipeconf with a
modified one (e.g., with updated <code class="docutils literal notranslate"><span class="pre">bmv2.json</span></code> and <code class="docutils literal notranslate"><span class="pre">p4info.txt</span></code>), the version of
ONOS used in this tutorial (2.2.0, the most recent at the time of writing) does
not support reloading the pipeconf behavior classes, in which case the old
classes will still be used. For this reason, to reload a modified version of
<code class="docutils literal notranslate"><span class="pre">InterpreterImpl.java</span></code>, you need to kill ONOS first.</p>
<p>In a terminal window, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make restart
</pre></div>
</div>
<p>This command will restart all containers, removing any state from previous
executions, including ONOS.</p>
<p>Wait approx. 20 seconds for ONOS to completing booting, or check the ONOS log
(<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">onos-log</span></code>) until no more messages are shown.</p>
</div>
<div class="section" id="load-updated-app-and-register-pipeconf">
<h3>5. Load updated app and register pipeconf<a class="headerlink" href="#load-updated-app-and-register-pipeconf" title="Permalink to this headline">¶</a></h3>
<p>On a terminal window, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make app-reload
</pre></div>
</div>
<p>This command will upload to ONOS and activate the app binary previously built (located at app/target/ngsdn-tutorial-1.0-SNAPSHOT.oar).</p>
</div>
<div class="section" id="push-netcfg-to-onos-to-trigger-device-and-link-discovery">
<h3>6. Push netcfg to ONOS to trigger device and link discovery<a class="headerlink" href="#push-netcfg-to-onos-to-trigger-device-and-link-discovery" title="Permalink to this headline">¶</a></h3>
<p>On a terminal window, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make netcfg
</pre></div>
</div>
<p>Use the ONOS CLI to verify that all devices have been discovered:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onos</span><span class="o">&gt;</span> <span class="n">devices</span> <span class="o">-</span><span class="n">s</span>
<span class="nb">id</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="p">,</span> <span class="n">available</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">MASTER</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SWITCH</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">stratum</span><span class="o">-</span><span class="n">bmv2</span><span class="p">:</span><span class="n">org</span><span class="o">.</span><span class="n">onosproject</span><span class="o">.</span><span class="n">ngsdn</span><span class="o">-</span><span class="n">tutorial</span>
<span class="nb">id</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="p">,</span> <span class="n">available</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">MASTER</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SWITCH</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">stratum</span><span class="o">-</span><span class="n">bmv2</span><span class="p">:</span><span class="n">org</span><span class="o">.</span><span class="n">onosproject</span><span class="o">.</span><span class="n">ngsdn</span><span class="o">-</span><span class="n">tutorial</span>
<span class="nb">id</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine1</span><span class="p">,</span> <span class="n">available</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">MASTER</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SWITCH</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">stratum</span><span class="o">-</span><span class="n">bmv2</span><span class="p">:</span><span class="n">org</span><span class="o">.</span><span class="n">onosproject</span><span class="o">.</span><span class="n">ngsdn</span><span class="o">-</span><span class="n">tutorial</span>
<span class="nb">id</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine2</span><span class="p">,</span> <span class="n">available</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">MASTER</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">SWITCH</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">stratum</span><span class="o">-</span><span class="n">bmv2</span><span class="p">:</span><span class="n">org</span><span class="o">.</span><span class="n">onosproject</span><span class="o">.</span><span class="n">ngsdn</span><span class="o">-</span><span class="n">tutorial</span>
</pre></div>
</div>
<p>Verify that all links have been discovered. You should see 8 links in total,
each one representing a direction of the 4 bidirectional links of our Mininet
topology:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onos</span><span class="o">&gt;</span> <span class="n">links</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine1</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine2</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine1</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine2</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
<span class="n">src</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">spine2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">DIRECT</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<p><strong>If you don’t see any link</strong>, check the ONOS log (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">onos-log</span></code>) for any
error with packet-in/out handling. In case of errors, it’s possible that you
have not modified <code class="docutils literal notranslate"><span class="pre">InterpreterImpl.java</span></code> correctly. In this case, go back to
exercise step 3.</p>
<p>Verify flow rules, you should see 5 flow rules for each device. For example,
to show all flow rules installed so far on device <code class="docutils literal notranslate"><span class="pre">leaf1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onos</span><span class="o">&gt;</span> <span class="n">flows</span> <span class="o">-</span><span class="n">s</span> <span class="nb">any</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf1</span>
<span class="n">deviceId</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="p">,</span> <span class="n">flowRuleCount</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">ADDED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">acl_table</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="p">[</span><span class="n">ETH_TYPE</span><span class="p">:</span><span class="n">lldp</span><span class="p">],</span> <span class="n">treatment</span><span class="o">=</span><span class="p">[</span><span class="n">immediate</span><span class="o">=</span><span class="p">[</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">clone_to_cpu</span><span class="p">()]]</span>
    <span class="n">ADDED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">acl_table</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="p">[</span><span class="n">ETH_TYPE</span><span class="p">:</span><span class="n">bddp</span><span class="p">],</span> <span class="n">treatment</span><span class="o">=</span><span class="p">[</span><span class="n">immediate</span><span class="o">=</span><span class="p">[</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">clone_to_cpu</span><span class="p">()]]</span>
    <span class="n">ADDED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">acl_table</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="p">[</span><span class="n">ETH_TYPE</span><span class="p">:</span><span class="n">arp</span><span class="p">],</span> <span class="n">treatment</span><span class="o">=</span><span class="p">[</span><span class="n">immediate</span><span class="o">=</span><span class="p">[</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">clone_to_cpu</span><span class="p">()]]</span>
    <span class="n">ADDED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">acl_table</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="p">[</span><span class="n">ETH_TYPE</span><span class="p">:</span><span class="n">ipv6</span><span class="p">,</span> <span class="n">IP_PROTO</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span> <span class="n">ICMPV6_TYPE</span><span class="p">:</span><span class="mi">136</span><span class="p">],</span> <span class="n">treatment</span><span class="o">=</span><span class="p">[</span><span class="n">immediate</span><span class="o">=</span><span class="p">[</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">clone_to_cpu</span><span class="p">()]]</span>
    <span class="n">ADDED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">acl_table</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="p">[</span><span class="n">ETH_TYPE</span><span class="p">:</span><span class="n">ipv6</span><span class="p">,</span> <span class="n">IP_PROTO</span><span class="p">:</span><span class="mi">58</span><span class="p">,</span> <span class="n">ICMPV6_TYPE</span><span class="p">:</span><span class="mi">135</span><span class="p">],</span> <span class="n">treatment</span><span class="o">=</span><span class="p">[</span><span class="n">immediate</span><span class="o">=</span><span class="p">[</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">clone_to_cpu</span><span class="p">()]]</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>These flow rules are the result of the translation of flow objectives generated
by the <code class="docutils literal notranslate"><span class="pre">hostprovider</span></code> and <code class="docutils literal notranslate"><span class="pre">lldpprovider</span></code> built-in apps.</p>
<p>Flow objectives are translated by the pipeconf, which provides a <code class="docutils literal notranslate"><span class="pre">Pipeliner</span></code>
behavior implementation (<a class="reference external" href="app/src/main/java/org/onosproject/ngsdn/tutorial/pipeconf/PipelinerImpl.java">PipelinerImpl.java</a>). These flow
rules specify a match key by using ONOS standard/known header fields, such as
<code class="docutils literal notranslate"><span class="pre">ETH_TYPE</span></code>, <code class="docutils literal notranslate"><span class="pre">ICMPV6_TYPE</span></code>, etc. These types are mapped to P4Info-specific match
fields by the pipeline interpreter
(<a class="reference external" href="app/src/main/java/org/onosproject/ngsdn/tutorial/pipeconf/InterpreterImpl.java">InterpreterImpl.java</a>, look for method
<code class="docutils literal notranslate"><span class="pre">mapCriterionType</span></code>)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">hostprovider</span></code> app provides host discovery capabilities by intercepting ARP
(<code class="docutils literal notranslate"><span class="pre">selector=[ETH_TYPE:arp]</span></code>) and NDP packets (<code class="docutils literal notranslate"><span class="pre">selector=[ETH_TYPE:ipv6,</span> <span class="pre">IP_PROTO:58,</span> <span class="pre">ICMPV6_TYPE:...]</span></code>), which are cloned to the controller
(<code class="docutils literal notranslate"><span class="pre">treatment=[immediate=[IngressPipeImpl.clone_to_cpu()]]</span></code>). Similarly,
<code class="docutils literal notranslate"><span class="pre">lldpprovider</span></code> generates flow objectives to intercept LLDP and BBDP packets
(<code class="docutils literal notranslate"><span class="pre">selector=[ETH_TYPE:lldp]</span></code> and <code class="docutils literal notranslate"><span class="pre">selector=[ETH_TYPE:bbdp]</span></code> ) periodically
emitted on all devices’ ports as P4Runtime packet-outs, allowing automatic link
discovery.</p>
<p>All flow rules refer to P4 action <code class="docutils literal notranslate"><span class="pre">clone_to_cpu()</span></code>, which invokes a
v1model-specific primitive to set the clone session ID:</p>
<div class="highlight-p4 notranslate"><div class="highlight"><pre><span></span>action clone_to_cpu() {
    clone3(CloneType.I2E, CPU_CLONE_SESSION_ID, ...);
}
</pre></div>
</div>
<p>To actually generate P4Runtime packet-in messages for matched packets, the
pipeconf’s pipeliner generates a <code class="docutils literal notranslate"><span class="pre">CLONE</span></code> <em>group</em>, internally translated into a
P4Runtime<code class="docutils literal notranslate"><span class="pre">CloneSessionEntry</span></code>, that maps <code class="docutils literal notranslate"><span class="pre">CPU_CLONE_SESSION_ID</span></code> to a set of
ports, just the CPU one in this case.</p>
<p>To show all groups installed in ONOS, you can use the <code class="docutils literal notranslate"><span class="pre">groups</span></code> command. For
example, to show groups on <code class="docutils literal notranslate"><span class="pre">leaf1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onos</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="nb">any</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf1</span>
<span class="n">deviceId</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="p">,</span> <span class="n">groupCount</span><span class="o">=</span><span class="mi">1</span>
   <span class="nb">id</span><span class="o">=</span><span class="mh">0x63</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ADDED</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">CLONE</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">appId</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">onosproject</span><span class="o">.</span><span class="n">core</span><span class="p">,</span> <span class="n">referenceCount</span><span class="o">=</span><span class="mi">0</span>
       <span class="nb">id</span><span class="o">=</span><span class="mh">0x63</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">OUTPUT</span><span class="p">:</span><span class="n">CONTROLLER</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="visualize-links-on-the-onos-ui">
<h3>7. Visualize links on the ONOS UI<a class="headerlink" href="#visualize-links-on-the-onos-ui" title="Permalink to this headline">¶</a></h3>
<p>Using the ONF Cloud Tutorial Portal, access the ONOS UI.
If you are using the tutorial VM, open up a browser (e.g. Firefox) to
<a class="reference external" href="http://127.0.0.1:8181/onos/ui">http://127.0.0.1:8181/onos/ui</a>.</p>
<p>On the same page where the ONOS topology view is shown:</p>
<ul class="simple">
<li>Press <code class="docutils literal notranslate"><span class="pre">L</span></code> to show device labels;</li>
<li>Press <code class="docutils literal notranslate"><span class="pre">A</span></code> multiple times until you see link stats, in either
packets/seconds (pps) or bits/seconds.</li>
</ul>
<p>Link stats are derived by ONOS by periodically obtaining the port counters for
each device. ONOS internally uses gNMI to read port information, including
counters.</p>
<p>In this case, you should see approximately 1 packet/s, as that’s the rate of
packet-outs generated by the <code class="docutils literal notranslate"><span class="pre">lldpprovider</span></code> app.</p>
</div>
</div>
<div class="section" id="part-2-host-discovery-l2-bridging">
<h2>Part 2: Host discovery &amp; L2 bridging<a class="headerlink" href="#part-2-host-discovery-l2-bridging" title="Permalink to this headline">¶</a></h2>
<p>By fixing packet I/O support in the pipeline interpreter we did not only get
link discovery, but also enabled the built-in <code class="docutils literal notranslate"><span class="pre">hostprovider</span></code> app to perform
<em>host</em> discovery. This service is required by our tutorial app to populate
the bridging tables of our P4 pipeline, to forward packets based on the
Ethernet destination address.</p>
<p>Indeed, the <code class="docutils literal notranslate"><span class="pre">hostprovider</span></code> app works by snooping incoming ARP/NDP packets on the
switch and deducing where a host is connected to from the packet-in message
metadata. Other apps in ONOS, like our tutorial app, can then listen for
host-related events and access information about their addresses (IP, MAC) and
location.</p>
<p>In the following, you will be asked to enable the app’s <code class="docutils literal notranslate"><span class="pre">L2BridgingComponent</span></code>,
and to verify that host discovery works by pinging hosts on Mininet. But before,
it’s useful to review how the starter code implements L2 bridging.</p>
<div class="section" id="overview-our-implementation-of-l2-bridging">
<h3>Overview: our implementation of L2 bridging<a class="headerlink" href="#overview-our-implementation-of-l2-bridging" title="Permalink to this headline">¶</a></h3>
<p>To make things easier, the starter code assumes that hosts of a given subnet are
all connected to the same leaf, and two interfaces of two different leaves
cannot be configured with the same IPv6 subnet. In other words, L2 bridging is
allowed only for hosts connected to the same leaf.</p>
<p>The Mininet script <a class="reference external" href="mininet/topo-v6.py">topo-v6.py</a> used in this tutorial
defines 4 subnets:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">2001:1:1::/64</span></code> with 3 hosts connected to <code class="docutils literal notranslate"><span class="pre">leaf1</span></code> (<code class="docutils literal notranslate"><span class="pre">h1a</span></code>, <code class="docutils literal notranslate"><span class="pre">h1b</span></code>, and <code class="docutils literal notranslate"><span class="pre">h1c</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">2001:1:2::/64</span></code> with 1 hosts connected to <code class="docutils literal notranslate"><span class="pre">leaf1</span></code> (<code class="docutils literal notranslate"><span class="pre">h2</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">2001:2:3::/64</span></code> with 1 hosts connected to <code class="docutils literal notranslate"><span class="pre">leaf2</span></code> (<code class="docutils literal notranslate"><span class="pre">h3</span></code>)</li>
<li><code class="docutils literal notranslate"><span class="pre">2001:2:4::/64</span></code> with 1 hosts connected to <code class="docutils literal notranslate"><span class="pre">leaf2</span></code> (<code class="docutils literal notranslate"><span class="pre">h4</span></code>)</li>
</ul>
<p>The same IPv6 prefixes are defined in the <a class="reference external" href="mininet/netcfg.json">netcfg.json</a>
file and are used to provide interface configuration to ONOS.</p>
<div class="section" id="data-plane">
<h4>Data plane<a class="headerlink" href="#data-plane" title="Permalink to this headline">¶</a></h4>
<p>The P4 code defines tables to forward packets based on the Ethernet address,
precisely, two distinct tables, to handle two different types of L2 entries:</p>
<ol class="simple">
<li>Unicast entries: which will be filled in by the control plane when the
location (port) of new hosts is learned.</li>
<li>Broadcast/multicast entries: used replicate NDP Neighbor Solicitation
(NS) messages to all host-facing ports;</li>
</ol>
<p>For (2), unlike ARP messages in IPv4, which are broadcasted to Ethernet
destination address FF:FF:FF:FF:FF:FF, NDP messages are sent to special Ethernet
addresses specified by RFC2464. These addresses are prefixed with 33:33 and the
last four octets are the last four octets of the IPv6 destination multicast
address. The most straightforward way of matching on such IPv6
broadcast/multicast packets, without digging in the details of RFC2464, is to
use a ternary match on <code class="docutils literal notranslate"><span class="pre">33:33:**:**:**:**</span></code>, where <code class="docutils literal notranslate"><span class="pre">*</span></code> means “don’t care”.</p>
<p>For this reason, our solution defines two tables. One that matches in an exact
fashion <code class="docutils literal notranslate"><span class="pre">l2_exact_table</span></code> (easier to scale on switch ASIC memory) and one that
uses ternary matching <code class="docutils literal notranslate"><span class="pre">l2_ternary_table</span></code> (which requires more expensive TCAM
memories, usually much smaller).</p>
<p>These tables are applied to packets in an order defined in the <code class="docutils literal notranslate"><span class="pre">apply</span></code> block
of the ingress pipeline (<code class="docutils literal notranslate"><span class="pre">IngressPipeImpl</span></code>):</p>
<div class="highlight-p4 notranslate"><div class="highlight"><pre><span></span>if (!l2_exact_table.apply().hit) {
    l2_ternary_table.apply();
}
</pre></div>
</div>
<p>The ternary table has lower priority, and it’s applied only if a matching entry
is not found in the exact one.</p>
<p><strong>Note</strong>: we won’t be using VLANs to segment our L2 domains. As such, when
matching packets in the <code class="docutils literal notranslate"><span class="pre">l2_ternary_table</span></code>, these will be broadcasted to ALL
host-facing ports.</p>
</div>
<div class="section" id="control-plane-l2bridgingcomponent">
<h4>Control plane (L2BridgingComponent)<a class="headerlink" href="#control-plane-l2bridgingcomponent" title="Permalink to this headline">¶</a></h4>
<p>We already provide an ONOS app component controlling the L2 bridging tables of
the P4 program: <a class="reference external" href="app/src/main/java/org/onosproject/ngsdn/tutorial/L2BridgingComponent.java">L2BridgingComponent.java</a></p>
<p>This app component defines two event listeners located at the bottom of the
<code class="docutils literal notranslate"><span class="pre">L2BridgingComponent</span></code> class, <code class="docutils literal notranslate"><span class="pre">InternalDeviceListener</span></code> for device events (e.g.
connection of a new switch) and <code class="docutils literal notranslate"><span class="pre">InternalHostListener</span></code> for host events (e.g. new
host discovered). These listeners in turn call methods like:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">setUpDevice()</span></code>: responsible for creating multicast groups for all
host-facing ports and inserting flow rules for the <code class="docutils literal notranslate"><span class="pre">l2_ternary_table</span></code> pointing
to such groups.</li>
<li><code class="docutils literal notranslate"><span class="pre">learnHost()</span></code>: responsible for inserting unicast L2 entries based on the
discovered host location.</li>
</ul>
<p>To support reloading the app implementation, these methods are also called at
component activation for all devices and hosts known by ONOS at the time of
activation (look for methods <code class="docutils literal notranslate"><span class="pre">activate()</span></code> and <code class="docutils literal notranslate"><span class="pre">setUpAllDevices()</span></code>).</p>
<p>To keep things simple, our broadcast domain will be restricted to a single
device, i.e. we allow packet replication only for ports of the same leaf switch.
As such, we can exclude ports going to the spines from the multicast group. To
determine whether a port is expected to be facing hosts or not, we look at the
interface configuration in <a class="reference external" href="mininet/netcfg.json">netcfg.json</a> file (look for the
<code class="docutils literal notranslate"><span class="pre">ports</span></code> section of the JSON file).</p>
</div>
</div>
<div class="section" id="enable-l2bridgingcomponent-and-reload-the-app">
<h3>1. Enable L2BridgingComponent and reload the app<a class="headerlink" href="#enable-l2bridgingcomponent-and-reload-the-app" title="Permalink to this headline">¶</a></h3>
<p>Before starting, you need to enable the app’s L2BridgingComponent, which is
currently disabled.</p>
<ol>
<li><p class="first">Open file:
<code class="docutils literal notranslate"><span class="pre">app/src/main/java/org/onosproject/ngsdn/tutorial/L2BridgingComponent.java</span></code></p>
</li>
<li><p class="first">Look for the class definition at the top and enable the component by setting
the <code class="docutils literal notranslate"><span class="pre">enabled</span></code> flag to <code class="docutils literal notranslate"><span class="pre">true</span></code></p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Component</span><span class="o">(</span>
        <span class="n">immediate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span>
        <span class="n">enabled</span> <span class="o">=</span> <span class="kc">true</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">L2BridgingComponent</span> <span class="o">{</span>
</pre></div>
</div>
</li>
<li><p class="first">Build the ONOS app with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">app-build</span></code></p>
</li>
<li><p class="first">Re-load the app to apply the changes with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">app-reload</span></code></p>
</li>
</ol>
<p>After reloading the app, you should see the following messages in the ONOS log
(<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">onos-log</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span>  <span class="p">[</span><span class="n">L2BridgingComponent</span><span class="p">]</span> <span class="n">Started</span>
<span class="o">...</span>
<span class="n">INFO</span>  <span class="p">[</span><span class="n">L2BridgingComponent</span><span class="p">]</span> <span class="o">***</span> <span class="n">L2</span> <span class="n">BRIDGING</span> <span class="o">-</span> <span class="n">Starting</span> <span class="n">initial</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">...</span>
<span class="n">INFO</span>  <span class="p">[</span><span class="n">L2BridgingComponent</span><span class="p">]</span> <span class="n">Adding</span> <span class="n">L2</span> <span class="n">multicast</span> <span class="n">group</span> <span class="k">with</span> <span class="mi">4</span> <span class="n">ports</span> <span class="n">on</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">...</span>
<span class="n">INFO</span>  <span class="p">[</span><span class="n">L2BridgingComponent</span><span class="p">]</span> <span class="n">Adding</span> <span class="n">L2</span> <span class="n">multicast</span> <span class="n">rules</span> <span class="n">on</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">...</span>
<span class="o">...</span>
<span class="n">INFO</span>  <span class="p">[</span><span class="n">L2BridgingComponent</span><span class="p">]</span> <span class="o">***</span> <span class="n">L2</span> <span class="n">BRIDGING</span> <span class="o">-</span> <span class="n">Starting</span> <span class="n">initial</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="o">...</span>
<span class="n">INFO</span>  <span class="p">[</span><span class="n">L2BridgingComponent</span><span class="p">]</span> <span class="n">Adding</span> <span class="n">L2</span> <span class="n">multicast</span> <span class="n">group</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">ports</span> <span class="n">on</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="o">...</span>
<span class="n">INFO</span>  <span class="p">[</span><span class="n">L2BridgingComponent</span><span class="p">]</span> <span class="n">Adding</span> <span class="n">L2</span> <span class="n">multicast</span> <span class="n">rules</span> <span class="n">on</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf2</span><span class="o">...</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="examine-flow-rules-and-groups">
<h3>2. Examine flow rules and groups<a class="headerlink" href="#examine-flow-rules-and-groups" title="Permalink to this headline">¶</a></h3>
<p>Check the ONOS flow rules, you should see 2 new flow rules for the
<code class="docutils literal notranslate"><span class="pre">l2_ternary_table</span></code> installed by L2BridgingComponent. For example, to show
all flow rules installed so far on device <code class="docutils literal notranslate"><span class="pre">leaf1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onos</span><span class="o">&gt;</span> <span class="n">flows</span> <span class="o">-</span><span class="n">s</span> <span class="nb">any</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf1</span>
<span class="n">deviceId</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="p">,</span> <span class="n">flowRuleCount</span><span class="o">=...</span>
    <span class="o">...</span>
    <span class="n">ADDED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">l2_ternary_table</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="p">[</span><span class="n">hdr</span><span class="o">.</span><span class="n">ethernet</span><span class="o">.</span><span class="n">dst_addr</span><span class="o">=</span><span class="mh">0x333300000000</span><span class="o">&amp;&amp;&amp;</span><span class="mh">0xffff00000000</span><span class="p">],</span> <span class="n">treatment</span><span class="o">=</span><span class="p">[</span><span class="n">immediate</span><span class="o">=</span><span class="p">[</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">set_multicast_group</span><span class="p">(</span><span class="n">gid</span><span class="o">=</span><span class="mh">0xff</span><span class="p">)]]</span>
    <span class="n">ADDED</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">l2_ternary_table</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="p">[</span><span class="n">hdr</span><span class="o">.</span><span class="n">ethernet</span><span class="o">.</span><span class="n">dst_addr</span><span class="o">=</span><span class="mh">0xffffffffffff</span><span class="o">&amp;&amp;&amp;</span><span class="mh">0xffffffffffff</span><span class="p">],</span> <span class="n">treatment</span><span class="o">=</span><span class="p">[</span><span class="n">immediate</span><span class="o">=</span><span class="p">[</span><span class="n">IngressPipeImpl</span><span class="o">.</span><span class="n">set_multicast_group</span><span class="p">(</span><span class="n">gid</span><span class="o">=</span><span class="mh">0xff</span><span class="p">)]]</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>To show also the multicast groups, you can use the <code class="docutils literal notranslate"><span class="pre">groups</span></code> command. For example
to show groups on <code class="docutils literal notranslate"><span class="pre">leaf1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onos</span><span class="o">&gt;</span> <span class="n">groups</span> <span class="nb">any</span> <span class="n">device</span><span class="p">:</span><span class="n">leaf1</span>
<span class="n">deviceId</span><span class="o">=</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="p">,</span> <span class="n">groupCount</span><span class="o">=</span><span class="mi">2</span>
   <span class="nb">id</span><span class="o">=</span><span class="mh">0x63</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ADDED</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">CLONE</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">appId</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">onosproject</span><span class="o">.</span><span class="n">core</span><span class="p">,</span> <span class="n">referenceCount</span><span class="o">=</span><span class="mi">0</span>
       <span class="nb">id</span><span class="o">=</span><span class="mh">0x63</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">OUTPUT</span><span class="p">:</span><span class="n">CONTROLLER</span><span class="p">]</span>
   <span class="nb">id</span><span class="o">=</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">ADDED</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">ALL</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">appId</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">onosproject</span><span class="o">.</span><span class="n">ngsdn</span><span class="o">-</span><span class="n">tutorial</span><span class="p">,</span> <span class="n">referenceCount</span><span class="o">=</span><span class="mi">0</span>
       <span class="nb">id</span><span class="o">=</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">OUTPUT</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
       <span class="nb">id</span><span class="o">=</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">OUTPUT</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
       <span class="nb">id</span><span class="o">=</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">OUTPUT</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
       <span class="nb">id</span><span class="o">=</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">weight</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">OUTPUT</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ALL</span></code> group is a new one, created by our app (<code class="docutils literal notranslate"><span class="pre">appId=org.onosproject.ngsdn-tutorial</span></code>).
Groups of type <code class="docutils literal notranslate"><span class="pre">ALL</span></code> in ONOS map to P4Runtime <code class="docutils literal notranslate"><span class="pre">MulticastGroupEntry</span></code>, in this
case used to broadcast NDP NS packets to all host-facing ports.</p>
</div>
<div class="section" id="test-l2-bridging-on-mininet">
<h3>3. Test L2 bridging on Mininet<a class="headerlink" href="#test-l2-bridging-on-mininet" title="Permalink to this headline">¶</a></h3>
<p>To verify that L2 bridging works as intended, send a ping between hosts in the
same subnet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h1a</span> <span class="n">ping</span> <span class="n">h1b</span>
<span class="n">PING</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="n">b</span><span class="p">(</span><span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="n">b</span><span class="p">)</span> <span class="mi">56</span> <span class="n">data</span> <span class="nb">bytes</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="n">b</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.580</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="n">b</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">3</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.483</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="n">b</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">4</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.484</span> <span class="n">ms</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Differently from exercise 1, here we have NOT set any NDP static entry.
Instead, NDP NS and NA packets are handled by the data plane thanks to the <code class="docutils literal notranslate"><span class="pre">ALL</span></code>
group and <code class="docutils literal notranslate"><span class="pre">l2_ternary_table</span></code>’s flow rule described above. Moreover, given the
ACL flow rules to clone NDP packets to the controller, hosts can be discovered
by ONOS. Host discovery events are used by <code class="docutils literal notranslate"><span class="pre">L2BridgingComponent.java</span></code> to insert
entries in the P4 <code class="docutils literal notranslate"><span class="pre">l2_exact_table</span></code>. Check the ONOS log, you should see messages
related to the discovery of hosts <code class="docutils literal notranslate"><span class="pre">h1a</span></code> and <code class="docutils literal notranslate"><span class="pre">h1b</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>INFO  [L2BridgingComponent] HOST_ADDED event! host=00:00:00:00:00:1A/None, deviceId=device:leaf1, port=3
INFO  [L2BridgingComponent] Adding L2 unicast rule on device:leaf1 for host 00:00:00:00:00:1A/None (port 3)...
INFO  [L2BridgingComponent] HOST_ADDED event! host=00:00:00:00:00:1B/None, deviceId=device:leaf1, port=4
INFO  [L2BridgingComponent] Adding L2 unicast rule on device:leaf1 for host 00:00:00:00:00:1B/None (port 4).
</pre></div>
</div>
</div>
<div class="section" id="visualize-hosts-on-the-onos-cli-and-web-ui">
<h3>4. Visualize hosts on the ONOS CLI and web UI<a class="headerlink" href="#visualize-hosts-on-the-onos-cli-and-web-ui" title="Permalink to this headline">¶</a></h3>
<p>You should see exactly two hosts in the ONOS CLI (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">onos-cli</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onos</span><span class="o">&gt;</span> <span class="n">hosts</span> <span class="o">-</span><span class="n">s</span>
<span class="nb">id</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">A</span><span class="o">/</span><span class="kc">None</span><span class="p">,</span> <span class="n">mac</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">A</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="p">[</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">/</span><span class="mi">3</span><span class="p">],</span> <span class="n">vlan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ip</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="n">a</span><span class="p">]</span>
<span class="nb">id</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">B</span><span class="o">/</span><span class="kc">None</span><span class="p">,</span> <span class="n">mac</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">B</span><span class="p">,</span> <span class="n">locations</span><span class="o">=</span><span class="p">[</span><span class="n">device</span><span class="p">:</span><span class="n">leaf1</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="n">vlan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ip</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">::</span><span class="n">b</span><span class="p">]</span>
</pre></div>
</div>
<p>Using the ONF Cloud Tutorial Portal, access the ONOS UI.
If you are using the tutorial VM, open up a browser (e.g. Firefox) to
<a class="reference external" href="http://127.0.0.1:8181/onos/ui">http://127.0.0.1:8181/onos/ui</a>.</p>
<p>To toggle showing hosts on the topology view, press <code class="docutils literal notranslate"><span class="pre">H</span></code> on your keyboard.</p>
</div>
</div>
<div class="section" id="congratulations">
<h2>Congratulations!<a class="headerlink" href="#congratulations" title="Permalink to this headline">¶</a></h2>
<p>You have completed the fourth exercise!</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="EXERCISE-5.html" class="btn btn-neutral float-right" title="Exercise 5: IPv6 routing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="EXERCISE-3.html" class="btn btn-neutral float-left" title="Exercise 3: Using ONOS as the control plane" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>

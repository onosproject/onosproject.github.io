

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Exercise 5: IPv6 routing &mdash; Software-Defined Networks: A Systems Approach Version 0.3-dev documentation</title>
  

  
  
    <link rel="shortcut icon" href="../static/bridge.ico"/>
  
  
  

  
  <script type="text/javascript" src="../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../static/documentation_options.js"></script>
        <script type="text/javascript" src="../static/jquery.js"></script>
        <script type="text/javascript" src="../static/underscore.js"></script>
        <script type="text/javascript" src="../static/doctools.js"></script>
        <script type="text/javascript" src="../static/language_data.js"></script>
    
    <script type="text/javascript" src="../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../static/css/rtd_theme_mods.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Exercise 6: Segment Routing v6 (SRv6)" href="EXERCISE-6.html" />
    <link rel="prev" title="Exercise 4: Enabling ONOS built-in services" href="EXERCISE-4.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Software-Defined Networks: A Systems Approach
          

          
          </a>

          
            
            
              <div class="version">
                Version 0.3-dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Chapter 1:  Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uses.html">Chapter 2:  Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">Chapter 3:  Basic Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../switch.html">Chapter 4:  White-Box Switches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stratum.html">Chapter 5:  Switch OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onos.html">Chapter 6:  Network OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trellis.html">Chapter 7:  Leaf-Spine Fabric</a></li>
<li class="toctree-l1"><a class="reference internal" href="../future.html">Chapter 8:  Future of SDN</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../exercises.html">Programming Exercises</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-1.html">Exercise 1: P4Runtime basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-2.html">Exercise 2: Yang, OpenConfig, and gNMI basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-3.html">Exercise 3: Using ONOS as the control plane</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-4.html">Exercise 4: Enabling ONOS built-in services</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Exercise 5: IPv6 routing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#try-pinging-hosts-in-different-subnets">Try pinging hosts in different subnets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-steps">Exercise steps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#modify-p4-program">1. Modify P4 program</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-ptf-tests">2. Run PTF tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-onos-app">3. Modify ONOS app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-ipv6-routing-on-mininet">4. Test IPv6 routing on Mininet</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#congratulations">Congratulations!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-a-understanding-onos-error-logs">Appendix A: Understanding ONOS error logs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-b-troubleshooting">Appendix B: Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-6.html">Exercise 6: Segment Routing v6 (SRv6)</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-7.html">Exercise 7: Trellis Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="EXERCISE-8.html">Exercise 8: GTP termination with fabric.p4</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">About This Book</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Software-Defined Networks: A Systems Approach</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../exercises.html">Programming Exercises</a> &raquo;</li>
        
      <li>Exercise 5: IPv6 routing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/exercises/EXERCISE-5.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="EXERCISE-6.html" class="btn btn-neutral float-right" title="Exercise 6: Segment Routing v6 (SRv6)" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="EXERCISE-4.html" class="btn btn-neutral float-left" title="Exercise 4: Enabling ONOS built-in services" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="exercise-5-ipv6-routing">
<h1>Exercise 5: IPv6 routing<a class="headerlink" href="#exercise-5-ipv6-routing" title="Permalink to this headline">¶</a></h1>
<p>In this exercise, you will be modifying the P4 program and ONOS app to add
support for IPv6-based (L3) routing between all hosts connected to the fabric,
with support for ECMP to balance traffic flows across multiple spines.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="requirements">
<h3>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<p>At this stage, we want our fabric to behave like a standard IP fabric, with
switches functioning as routers. As such, the following requirements should be
satisfied:</p>
<ul class="simple">
<li>Leaf interfaces should be assigned with an IPv6 address (the gateway address)
and a MAC address that we will call <code class="docutils literal notranslate"><span class="pre">myStationMac</span></code>;</li>
<li>Leaf switches should be able to handle NDP Neighbor Solicitation (NS)
messages – sent by hosts to resolve the MAC address associated with the
switch interface/gateway IPv6 addresses, by replying with NDP Neighbor
Advertisements (NA) notifying their <code class="docutils literal notranslate"><span class="pre">myStationMac</span></code> address;</li>
<li>Packets received with Ethernet destination <code class="docutils literal notranslate"><span class="pre">myStationMac</span></code> should be processed
through the routing tables (traffic that is not dropped can then be
processed through the bridging tables);</li>
<li>When routing, the P4 program should look at the IPv6 destination address. If a
matching entry is found, the packet should be forwarded to a given next hop
and the packet’s Ethernet addresses should be modified accordingly (source set
to <code class="docutils literal notranslate"><span class="pre">myStationMac</span></code> and destination to the next hop one);</li>
<li>When routing packets to a different leaf across the spines, leaf switches
should be able to use ECMP to distribute traffic.</li>
</ul>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="mininet/netcfg.json">netcfg.json</a> file includes a special configuration for
each device named <code class="docutils literal notranslate"><span class="pre">fabricDeviceConfig</span></code>, this block defines 3 values:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">myStationMac</span></code>: MAC address associated with each device, i.e., the router MAC
address;</li>
<li><code class="docutils literal notranslate"><span class="pre">mySid</span></code>: the SRv6 segment ID of the device, used in the next exercise.</li>
<li><code class="docutils literal notranslate"><span class="pre">isSpine</span></code>: a boolean flag, indicating whether the device should be considered
as a spine switch.</li>
</ul>
<p>Moreover, the <a class="reference external" href="mininet/netcfg.json">netcfg.json</a> file also includes a list of
interfaces with an IPv6 prefix assigned to them (look under the <code class="docutils literal notranslate"><span class="pre">ports</span></code> section
of the file). The same IPv6 addresses are used in the Mininet topology script
<a class="reference external" href="mininet/topo-v6.py">topo-v6.py</a>.</p>
</div>
<div class="section" id="try-pinging-hosts-in-different-subnets">
<h3>Try pinging hosts in different subnets<a class="headerlink" href="#try-pinging-hosts-in-different-subnets" title="Permalink to this headline">¶</a></h3>
<p>Similarly to the previous exercise, let’s start by using Mininet to verify that
pinging between hosts on different subnets does NOT work. It will be your task
to make it work.</p>
<p>On the Mininet CLI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h2</span> <span class="n">ping</span> <span class="n">h3</span>
<span class="n">PING</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">::</span><span class="mi">1</span><span class="p">(</span><span class="mi">2001</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">::</span><span class="mi">1</span><span class="p">)</span> <span class="mi">56</span> <span class="n">data</span> <span class="nb">bytes</span>
<span class="n">From</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">Destination</span> <span class="n">unreachable</span><span class="p">:</span> <span class="n">Address</span> <span class="n">unreachable</span>
<span class="n">From</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">Destination</span> <span class="n">unreachable</span><span class="p">:</span> <span class="n">Address</span> <span class="n">unreachable</span>
<span class="n">From</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">3</span> <span class="n">Destination</span> <span class="n">unreachable</span><span class="p">:</span> <span class="n">Address</span> <span class="n">unreachable</span>
<span class="o">...</span>
</pre></div>
</div>
<p>If you check the ONOS log, you will notice that <code class="docutils literal notranslate"><span class="pre">h2</span></code> has been discovered:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>INFO  [L2BridgingComponent] HOST_ADDED event! host=00:00:00:00:00:20/None, deviceId=device:leaf1, port=6
INFO  [L2BridgingComponent] Adding L2 unicast rule on device:leaf1 for host 00:00:00:00:00:20/None (port 6)...
</pre></div>
</div>
<p>That’s because <code class="docutils literal notranslate"><span class="pre">h2</span></code> sends NDP NS messages to resolve the MAC address of its
gateway (<code class="docutils literal notranslate"><span class="pre">2001:1:2::ff</span></code> as configured in <a class="reference external" href="mininet/topo-v6.py">topo-v6.py</a>).</p>
<p>We can check the IPv6 neighbor table for <code class="docutils literal notranslate"><span class="pre">h2</span></code> to see that the resolution
has failed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h2</span> <span class="n">ip</span> <span class="o">-</span><span class="mi">6</span> <span class="n">n</span>
<span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="n">ff</span> <span class="n">dev</span> <span class="n">h2</span><span class="o">-</span><span class="n">eth0</span>  <span class="n">FAILED</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exercise-steps">
<h2>Exercise steps<a class="headerlink" href="#exercise-steps" title="Permalink to this headline">¶</a></h2>
<div class="section" id="modify-p4-program">
<h3>1. Modify P4 program<a class="headerlink" href="#modify-p4-program" title="Permalink to this headline">¶</a></h3>
<p>The first step will be to add new tables to <code class="docutils literal notranslate"><span class="pre">main.p4</span></code>.</p>
<div class="section" id="p4-based-generation-of-ndp-messages">
<h4>P4-based generation of NDP messages<a class="headerlink" href="#p4-based-generation-of-ndp-messages" title="Permalink to this headline">¶</a></h4>
<p>We already provide ways to handle NDP NS and NA exchanged by hosts connected to
the same subnet (see <code class="docutils literal notranslate"><span class="pre">l2_ternary_table</span></code>). However, for hosts, the Linux
networking stack takes care of generating a NDP NA reply. For the switches in
our fabric, there’s no traditional networking stack associated to it.</p>
<p>There are multiple solutions to this problem:</p>
<ul class="simple">
<li>we can configure hosts with static NDP entries, removing the need for the
switch to reply to NDP NS packets;</li>
<li>we can intercept NDP NS via packet-in, generate a corresponding NDP NA
reply in ONOS, and send it back via packet-out; or</li>
<li>we can instruct the switch to generate NDP NA replies using P4. That is, we
can write P4 code that takes care of replying to NDP requests without any
intervention from the control plane.</li>
</ul>
<p><strong>Note:</strong> The rest of the exercise assume you will decide to implement the last
option. You can decide to go with a different one, but you should keep in mind
that there will be less starter code for you to re-use.</p>
<p>The idea is simple: NDP NA packets have the same header structure as NDP NS
ones. They are both ICMPv6 packets with different header field values, such as
different ICMPv6 type, different Ethernet addresses etc. A switch that knows the
MAC address of a given IPv6 target address found in an NDP NS request, can
transform the same packet to an NDP NA reply by modifying some of its fields.</p>
<p>To implement P4-based generation of NDP NA messages, look in
<a class="reference external" href="p4src/snippets.p4">p4src/snippets.p4</a>, we already provide an action named
<code class="docutils literal notranslate"><span class="pre">ndp_ns_to_na</span></code> to transform an NDP NS packet into an NDP NA one. Your task is to
implement a table that uses such action.</p>
<p>This table should define a mapping between the interface IPv6 addresses provided
in <a class="reference external" href="mininet/netcfg.json">netcfg.json</a> and the <code class="docutils literal notranslate"><span class="pre">myStationMac</span></code> associated to each
switch (also defined in netcfg.json). When an NDP NS packet is received, asking
to resolve one of such IPv6 addresses, the <code class="docutils literal notranslate"><span class="pre">ndp_ns_to_na</span></code> action should be
invoked with the given <code class="docutils literal notranslate"><span class="pre">myStationMac</span></code> as parameter. The ONOS app will be
responsible of inserting entries in this table according to the content of
netcfg.json.</p>
<p>The ONOS app already provides a component
<a class="reference external" href="app/src/main/java/org/onosproject/ngsdn/tutorial/NdpReplyComponent.java">NdpReplyComponent.java</a>
responsible of inserting entries in this table.</p>
<p>The component is currently disabled; you will need to enable and modify it in
the next steps. But for now, let’s focus on the P4 program</p>
</div>
<div class="section" id="lpm-ipv6-routing-table">
<h4>LPM IPv6 routing table<a class="headerlink" href="#lpm-ipv6-routing-table" title="Permalink to this headline">¶</a></h4>
<p>The main table for this exercise will be an L3 table that matches on the
destination IPv6 address. You should create a table that performs longest
prefix match (LPM) on the destination address and performs the required packet
transformations:</p>
<ol class="simple">
<li>Replace the source Ethernet address with the destination one, expected to be
<code class="docutils literal notranslate"><span class="pre">myStationMac</span></code> (see next section on “My Station” table);</li>
<li>Set the destination Ethernet to the next hop’s address (passed as an action
argument);</li>
<li>Decrement the IPv6 <code class="docutils literal notranslate"><span class="pre">hop_limit</span></code>.</li>
</ol>
<p>This L3 table and action should provide a mapping between a given IPv6 prefix
and a next hop MAC address. In our solution (and hence in the PTF starter code
and ONOS app), we re-use the L2 table defined in Exercise 2 to provide a mapping
between the next hop MAC address and an output port. If you want to apply the
same solution, make sure to call the L3 table before the L2 one in the <code class="docutils literal notranslate"><span class="pre">apply</span></code>
block.</p>
<p>Moreover, we will want to drop the packet when the IPv6 hop limit reaches 0.
This can be accomplished by inserting logic in the <code class="docutils literal notranslate"><span class="pre">apply</span></code> block that inspects
the field after applying your L3 table.</p>
<p>At this point, your pipeline should properly match, transform, and forward IPv6
packets.</p>
<p><strong>Note:</strong> For simplicity, we are using a global routing table. If you would like
to segment your routing table in virtual ones (i.e. using a VRF ID), you can
tackle this as an extra credit.</p>
</div>
<div class="section" id="my-station-table">
<h4>“My Station” table<a class="headerlink" href="#my-station-table" title="Permalink to this headline">¶</a></h4>
<p>You may realize that at this point the switch will perform IPv6 routing
indiscriminately, which is technically incorrect. The switch should only route
Ethernet frames that are destined for the router’s Ethernet address
(<code class="docutils literal notranslate"><span class="pre">myStationMac</span></code>).</p>
<p>To address this issue, you will need to create a table that will match the
destination Ethernet address and mark the packet for routing if there is a
match. We call this the “My Station” table.</p>
<p>You are free to use a specific action or metadata to carry this information, or
for simplicity, you can use <code class="docutils literal notranslate"><span class="pre">NoAction</span></code> and check for a hit in this table in your
<code class="docutils literal notranslate"><span class="pre">apply</span></code> block. Remember to update your <code class="docutils literal notranslate"><span class="pre">apply</span></code> block after creating this table.</p>
</div>
<div class="section" id="adding-support-for-ecmp-with-action-selectors">
<h4>Adding support for ECMP with action selectors<a class="headerlink" href="#adding-support-for-ecmp-with-action-selectors" title="Permalink to this headline">¶</a></h4>
<p>The last modification that you will make to the pipeline is to add an
<code class="docutils literal notranslate"><span class="pre">action_selector</span></code> that will hash traffic between the different possible next
hops. In our leaf-spine topology, we have an equal-cost path for each spine for
every leaf pair, and we want to be able to take advantage of that.</p>
<p>We have already defined the P4 <code class="docutils literal notranslate"><span class="pre">ecmp_selector</span></code> in
<a class="reference external" href="p4src/snippets.p4">p4src/snippets.p4</a>, but you will need to add the selector to
your L3 table. You will also need to add the selector fields as match keys.</p>
<p>For IPv6 traffic, you will need to include the source and destination IPv6
addresses as well as the IPv6 flow label as part of the ECMP hash, but you are
free to include other parts of the packet header if you would like. For example,
you could include the rest of the 5-tuple (i.e. L4 proto and ports); the L4
ports are parsed into <code class="docutils literal notranslate"><span class="pre">local_metadata</span></code> if would like to use them. For more
details on the required fields for hashing IPv6 traffic, see RFC6438.</p>
<p>You can compile the program using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">p4-build</span></code>.</p>
<p>Make sure to address any compiler errors before continuing.</p>
<p>At this point, our P4 pipeline should be ready for testing.</p>
</div>
</div>
<div class="section" id="run-ptf-tests">
<h3>2. Run PTF tests<a class="headerlink" href="#run-ptf-tests" title="Permalink to this headline">¶</a></h3>
<p>Tests for the IPv6 routing behavior are located in <code class="docutils literal notranslate"><span class="pre">ptf/tests/routing.py</span></code>. Open
that file up and modify wherever requested (look for <code class="docutils literal notranslate"><span class="pre">TODO</span> <span class="pre">EXERCISE</span> <span class="pre">5</span></code>).</p>
<p>To run all the tests for this exercise:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">routing</span>
</pre></div>
</div>
<p>This command will run all tests in the <code class="docutils literal notranslate"><span class="pre">routing</span></code> group (i.e. the content of
<code class="docutils literal notranslate"><span class="pre">ptf/tests/routing.py</span></code>). To run a specific test case you can use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=&lt;</span><span class="n">PYTHON</span> <span class="n">MODULE</span><span class="o">&gt;.&lt;</span><span class="n">TEST</span> <span class="n">CLASS</span> <span class="n">NAME</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">routing</span><span class="o">.</span><span class="n">NdpReplyGenTest</span>
</pre></div>
</div>
<div class="section" id="check-for-regressions">
<h4>Check for regressions<a class="headerlink" href="#check-for-regressions" title="Permalink to this headline">¶</a></h4>
<p>To make sures the new changes are not breaking other features, make sure to run
tests of the previous exercises as well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">packetio</span>
<span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">bridging</span>
<span class="n">make</span> <span class="n">p4</span><span class="o">-</span><span class="n">test</span> <span class="n">TEST</span><span class="o">=</span><span class="n">routing</span>
</pre></div>
</div>
<p>If all tests succeed, congratulations! You can move to the next step.</p>
</div>
</div>
<div class="section" id="modify-onos-app">
<h3>3. Modify ONOS app<a class="headerlink" href="#modify-onos-app" title="Permalink to this headline">¶</a></h3>
<p>The last part of the exercise is to update the starter code for the routing
components of our ONOS app, located here:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">app/src/main/java/org/onosproject/ngsdn/tutorial/Ipv6RoutingComponent.java</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">app/src/main/java/org/onosproject/ngsdn/tutorial/NdpReplyComponent.java</span></code></li>
</ul>
<p>Open those files and modify wherever requested (look for <code class="docutils literal notranslate"><span class="pre">TODO</span> <span class="pre">EXERCISE</span> <span class="pre">5</span></code>).</p>
<div class="section" id="ipv6routingcomponent-java">
<h4>Ipv6RoutingComponent.java<a class="headerlink" href="#ipv6routingcomponent-java" title="Permalink to this headline">¶</a></h4>
<p>The starter code already provides an implementation for event listeners and the
routing policy, i.e., methods triggered as a consequence of topology events, for
example to compute ECMP groups based on the available links between leaves and a
spines.</p>
<p>You are asked to modify the implementation of 4 methods.</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">setUpMyStationTable()</span></code>: to insert flow rules for the “My Station” table;</li>
<li><code class="docutils literal notranslate"><span class="pre">createNextHopGroup()</span></code>: responsible of creating the ONOS equivalent of a
P4Runtime action profile group for the ECMP selector of the routing table;</li>
<li><code class="docutils literal notranslate"><span class="pre">createRoutingRule()</span></code>: to create a flow rule for the IPv6 routing table;</li>
<li><code class="docutils literal notranslate"><span class="pre">createL2NextHopRule()</span></code>: to create flow rules mapping next hop MAC addresses
(used in the ECMP groups) to output ports. You can find a similar method in
the <code class="docutils literal notranslate"><span class="pre">L2BridgingComponent</span></code> (see <code class="docutils literal notranslate"><span class="pre">learnHost()</span></code> method). This one is called to
create L2 rules between switches, e.g. to forward packets between leaves and
spines. There’s no need to handle L2 rules for hosts since those are inserted
by the <code class="docutils literal notranslate"><span class="pre">L2BridgingComponent</span></code>.</li>
</ul>
</div>
<div class="section" id="ndpreplycomponent-java">
<h4>NdpReplyComponent.java<a class="headerlink" href="#ndpreplycomponent-java" title="Permalink to this headline">¶</a></h4>
<p>This component listens to device events. Each time a new device is added in
ONOS, it uses the content of netcfg.json to populate the NDP reply table.</p>
<p>You are asked to modify the implementation of method <code class="docutils literal notranslate"><span class="pre">buildNdpReplyFlowRule()</span></code>,
to insert the name of the table and action to generate NDP replies.</p>
</div>
<div class="section" id="enable-the-routing-components">
<h4>Enable the routing components<a class="headerlink" href="#enable-the-routing-components" title="Permalink to this headline">¶</a></h4>
<p>Once you’re confident your solution to the previous step should work, before
building and reloading the app, remember to enable the routing-related
components by setting the <code class="docutils literal notranslate"><span class="pre">enabled</span></code> flag to <code class="docutils literal notranslate"><span class="pre">true</span></code> at the top of the class
definition.</p>
<p>For IPv6 routing to work, you should enable the following components:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Ipv6RoutingComponent.java</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">NdpReplyComponent.java</span></code></li>
</ul>
</div>
<div class="section" id="build-and-reload-the-app">
<h4>Build and reload the app<a class="headerlink" href="#build-and-reload-the-app" title="Permalink to this headline">¶</a></h4>
<p>Use the following command to build and reload your app while ONOS is running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make app-build app-reload
</pre></div>
</div>
<p>When building the app, the modified P4 compiler outputs (<code class="docutils literal notranslate"><span class="pre">bmv2.json</span></code> and
<code class="docutils literal notranslate"><span class="pre">p4info.txt</span></code>) will be packaged together along with the Java classes. After
reloading the app, you should see messages in the ONOS log signaling that a new
pipeline configuration has been set and the <code class="docutils literal notranslate"><span class="pre">Ipv6RoutingComponent</span></code> and
<code class="docutils literal notranslate"><span class="pre">NdpReplyComponent</span></code> have been activated. Check also the log for potentially
harmful messages (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">onos-log</span></code>). If needed, take a look at section <strong>Appendix
A: Understanding ONOS error logs</strong> at the end of this exercise.</p>
</div>
</div>
<div class="section" id="test-ipv6-routing-on-mininet">
<h3>4. Test IPv6 routing on Mininet<a class="headerlink" href="#test-ipv6-routing-on-mininet" title="Permalink to this headline">¶</a></h3>
<div class="section" id="verify-ping">
<h4>Verify ping<a class="headerlink" href="#verify-ping" title="Permalink to this headline">¶</a></h4>
<p>Type the following commands in the Mininet CLI, in order:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h2</span> <span class="n">ping</span> <span class="n">h3</span>
<span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h3</span> <span class="n">ping</span> <span class="n">h2</span>
<span class="n">PING</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span><span class="p">(</span><span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span><span class="p">)</span> <span class="mi">56</span> <span class="n">data</span> <span class="nb">bytes</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">61</span> <span class="n">time</span><span class="o">=</span><span class="mf">2.39</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">3</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">61</span> <span class="n">time</span><span class="o">=</span><span class="mf">2.29</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mi">2001</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">::</span><span class="mi">1</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">4</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">61</span> <span class="n">time</span><span class="o">=</span><span class="mf">2.71</span> <span class="n">ms</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Now ping between <code class="docutils literal notranslate"><span class="pre">h3</span></code> and <code class="docutils literal notranslate"><span class="pre">h2</span></code> should work. If ping does NOT work, check section
<strong>Appendix B: Troubleshooting</strong> at the end of this exercise.</p>
<p>The ONOS log should show messages such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>INFO  [Ipv6RoutingComponent] HOST_ADDED event! host=00:00:00:00:00:20/None, deviceId=device:leaf1, port=6
INFO  [Ipv6RoutingComponent] Adding routes on device:leaf1 for host 00:00:00:00:00:20/None [[2001:1:2::1]]
...
INFO  [Ipv6RoutingComponent] HOST_ADDED event! host=00:00:00:00:00:30/None, deviceId=device:leaf2, port=3
INFO  [Ipv6RoutingComponent] Adding routes on device:leaf2 for host 00:00:00:00:00:30/None [[2001:2:3::1]]
...
</pre></div>
</div>
<p>If you don’t see messages regarding the discovery of <code class="docutils literal notranslate"><span class="pre">h2</span></code> (<code class="docutils literal notranslate"><span class="pre">00:00:00:00:00:20</span></code>)
it’s because ONOS has already discovered that host when you tried to ping at
the beginning of the exercise.</p>
<p><strong>Note:</strong> we need to start the ping first from <code class="docutils literal notranslate"><span class="pre">h2</span></code> and then from <code class="docutils literal notranslate"><span class="pre">h3</span></code> to let
ONOS discover the location of both hosts before ping packets can be forwarded.
That’s because the current implementation requires hosts to generate NDP NS
packets to be discovered by ONOS. To avoid having to manually generate NDP NS
messages, a possible solution could be:</p>
<ul class="simple">
<li>Configure IPv6 hosts in Mininet to periodically and automatically generate a
different type of NDP messages, named Router Solicitation (RS).</li>
<li>Insert a flow rule in the ACL table to clone NDP RS packets to the CPU. This
would require matching on a different value of ICMPv6 code other than NDP NA
and NS.</li>
<li>Modify the <code class="docutils literal notranslate"><span class="pre">hostprovider</span></code> built-in app implementation to learn host location
from NDP RS messages (it currently uses only NDP NA and NS).</li>
</ul>
</div>
<div class="section" id="verify-p4-based-ndp-na-generation">
<h4>Verify P4-based NDP NA generation<a class="headerlink" href="#verify-p4-based-ndp-na-generation" title="Permalink to this headline">¶</a></h4>
<p>To verify that the P4-based generation of NDP NA replies by the switch is
working, you can check the neighbor table of <code class="docutils literal notranslate"><span class="pre">h2</span></code> or <code class="docutils literal notranslate"><span class="pre">h3</span></code>, it should show
something similar to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h3</span> <span class="n">ip</span> <span class="o">-</span><span class="mi">6</span> <span class="n">n</span>
<span class="mi">2001</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">::</span><span class="n">ff</span> <span class="n">dev</span> <span class="n">h3</span><span class="o">-</span><span class="n">eth0</span> <span class="n">lladdr</span> <span class="mi">00</span><span class="p">:</span><span class="n">aa</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="n">router</span> <span class="n">REACHABLE</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">2001:2:3::ff</span></code> is the IPv6 gateway address defined in <code class="docutils literal notranslate"><span class="pre">netcfg.json</span></code> and
<code class="docutils literal notranslate"><span class="pre">topo-v6.py</span></code>, and <code class="docutils literal notranslate"><span class="pre">00:aa:00:00:00:02</span></code> is the <code class="docutils literal notranslate"><span class="pre">myStationMac</span></code> defined for <code class="docutils literal notranslate"><span class="pre">leaf2</span></code>
in <code class="docutils literal notranslate"><span class="pre">netcfg.json</span></code>.</p>
</div>
<div class="section" id="visualize-ecmp-using-the-onos-web-ui">
<h4>Visualize ECMP using the ONOS web UI<a class="headerlink" href="#visualize-ecmp-using-the-onos-web-ui" title="Permalink to this headline">¶</a></h4>
<p>To verify that ECMP is working, let’s start multiple parallel traffic flows from
<code class="docutils literal notranslate"><span class="pre">h2</span></code> to <code class="docutils literal notranslate"><span class="pre">h3</span></code> using iperf. In the Mininet command prompt, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h2</span> <span class="n">iperf</span> <span class="o">-</span><span class="n">c</span> <span class="n">h3</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">V</span> <span class="o">-</span><span class="n">P5</span> <span class="o">-</span><span class="n">b1M</span> <span class="o">-</span><span class="n">t600</span> <span class="o">-</span><span class="n">i1</span>
</pre></div>
</div>
<p>This commands will start an iperf client on <code class="docutils literal notranslate"><span class="pre">h2</span></code>, sending UDP packets (<code class="docutils literal notranslate"><span class="pre">-u</span></code>)
over IPv6 (<code class="docutils literal notranslate"><span class="pre">-V</span></code>) to <code class="docutils literal notranslate"><span class="pre">h3</span></code> (<code class="docutils literal notranslate"><span class="pre">-c</span></code>). In doing this, we generate 5 distinct flows
(<code class="docutils literal notranslate"><span class="pre">-P5</span></code>), each one capped at 1Mbit/s (<code class="docutils literal notranslate"><span class="pre">-b1M</span></code>), running for 10 minutes (<code class="docutils literal notranslate"><span class="pre">-t600</span></code>)
and reporting stats every 1 second (<code class="docutils literal notranslate"><span class="pre">-i1</span></code>).</p>
<p>Since we are generating UDP traffic, there’s no need to start an iperf server
on <code class="docutils literal notranslate"><span class="pre">h3</span></code>.</p>
<p>Using the ONF Cloud Tutorial Portal, access the ONOS UI.
If you are using the tutorial VM, open up a browser (e.g. Firefox) to
<a class="reference external" href="http://127.0.0.1:8181/onos/ui">http://127.0.0.1:8181/onos/ui</a>. When asked, use the username <code class="docutils literal notranslate"><span class="pre">onos</span></code> and
password <code class="docutils literal notranslate"><span class="pre">rocks</span></code>.</p>
<p>On the same page showing the ONOS topology:</p>
<ul class="simple">
<li>Press <code class="docutils literal notranslate"><span class="pre">H</span></code> on your keyboard to show hosts;</li>
<li>Press <code class="docutils literal notranslate"><span class="pre">L</span></code> to show device labels;</li>
<li>Press <code class="docutils literal notranslate"><span class="pre">A</span></code> multiple times until you see port/link stats, in either
packets/seconds (pps) or bits/seconds.</li>
</ul>
<p>If you completed the P4 and app implementation correctly, and ECMP is working,
you should see traffic being forwarded to both spines as in the screenshot
below:</p>
<img src="img/routing-ecmp.png" alt="ECMP Test" width="344"/></div>
</div>
</div>
<div class="section" id="congratulations">
<h2>Congratulations!<a class="headerlink" href="#congratulations" title="Permalink to this headline">¶</a></h2>
<p>You have completed the sixth exercise! Now your fabric is capable of forwarding
IPv6 traffic between any host.</p>
</div>
<div class="section" id="appendix-a-understanding-onos-error-logs">
<h2>Appendix A: Understanding ONOS error logs<a class="headerlink" href="#appendix-a-understanding-onos-error-logs" title="Permalink to this headline">¶</a></h2>
<p>There are mainly 2 types of errors that you might see when
reloading the app:</p>
<ol>
<li><p class="first">Write errors, such as removing a nonexistent entity or inserting one that
already exists:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARN</span>  <span class="p">[</span><span class="n">WriteResponseImpl</span><span class="p">]</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">DELETE</span> <span class="n">PRE</span> <span class="n">entry</span> <span class="n">on</span> <span class="n">device</span><span class="o">...</span><span class="p">:</span> <span class="n">NOT_FOUND</span> <span class="n">Multicast</span> <span class="n">group</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span> <span class="o">...</span>
<span class="n">WARN</span>  <span class="p">[</span><span class="n">WriteResponseImpl</span><span class="p">]</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">INSERT</span> <span class="n">table</span> <span class="n">entry</span> <span class="n">on</span> <span class="n">device</span><span class="o">...</span><span class="p">:</span> <span class="n">ALREADY_EXIST</span> <span class="n">Match</span> <span class="n">entry</span> <span class="n">exists</span><span class="p">,</span> <span class="n">use</span> <span class="n">MODIFY</span> <span class="k">if</span> <span class="n">you</span> <span class="n">wish</span> <span class="n">to</span> <span class="n">change</span> <span class="n">action</span> <span class="o">...</span>
</pre></div>
</div>
<p>These are usually transient errors and <strong>you should not worry about them</strong>.
They describe a temporary inconsistency of the ONOS-internal device state,
which should be soon recovered by a periodic reconciliation mechanism.
The ONOS core periodically polls the device state to make sure its
internal representation is accurate, while writing any pending modifications
to the device, solving these errors.</p>
<p>Otherwise, if you see them appearing periodically (every 3-4 seconds), it
means the reconciliation process is not working and something else is wrong.
Try re-loading the app (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">app-reload</span></code>); if that doesn’t resolve the
warnings, check with the instructors.</p>
</li>
<li><p class="first">Translation errors, signifying that ONOS is not able to translate the flow
rules (or groups) generated by apps, to a representation that is compatible
with your P4Info. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARN</span>  <span class="p">[</span><span class="n">P4RuntimeFlowRuleProgrammable</span><span class="p">]</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">flow</span> <span class="n">rule</span> <span class="k">for</span> <span class="n">pipeconf</span> <span class="s1">&#39;org.onosproject.ngsdn-tutorial&#39;</span><span class="p">:</span><span class="o">...</span>
</pre></div>
</div>
<p><strong>Read carefully the error message and make changes to the app as needed.</strong>
Chances are that you are using a table, match field, or action name that
does not exist in your P4Info. Check your P4Info file, modify, and reload the
app (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">app-build</span> <span class="pre">app-reload</span></code>).</p>
</li>
</ol>
</div>
<div class="section" id="appendix-b-troubleshooting">
<h2>Appendix B: Troubleshooting<a class="headerlink" href="#appendix-b-troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>If ping is not working, here are few steps you can take to troubleshoot your
network:</p>
<ol class="simple">
<li><strong>Check that all flow rules and groups have been written successfully to the
device.</strong> Using ONOS CLI commands such as <code class="docutils literal notranslate"><span class="pre">flows</span> <span class="pre">-s</span> <span class="pre">any</span> <span class="pre">device:leaf1</span></code> and
<code class="docutils literal notranslate"><span class="pre">groups</span> <span class="pre">any</span> <span class="pre">device:leaf1</span></code>, verify that all flows and groups are in state
<code class="docutils literal notranslate"><span class="pre">ADDED</span></code>. If you see other states such as <code class="docutils literal notranslate"><span class="pre">PENDING_ADD</span></code>, check the ONOS log
for possible errors with writing those entries to the device. You can also
use the ONOS web UI to check flows and group state.</li>
<li><strong>Use table counters to verify that tables are being hit as expected.</strong>
If you don’t already have direct counters defined for your table(s), modify
the P4 program to add some, build and reload the app (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">app-build</span> <span class="pre">app-reload</span></code>). ONOS should automatically detect that and poll counters every
3-4 seconds (the same period for the reconciliation process). To check their
values, you can either use the ONOS CLI (<code class="docutils literal notranslate"><span class="pre">flows</span> <span class="pre">-s</span> <span class="pre">any</span> <span class="pre">device:leaf1</span></code>) or the
web UI.</li>
<li><strong>Double check the PTF tests</strong> and make sure you are creating similar flow
rules in the <code class="docutils literal notranslate"><span class="pre">Ipv6RoutingComponent.java</span></code> and <code class="docutils literal notranslate"><span class="pre">NdpReplyComponenet.java</span></code>. Do
you notice any difference?</li>
<li><strong>Look at the BMv2 logs for possible errors.</strong> Check file
<code class="docutils literal notranslate"><span class="pre">/tmp/leaf1/stratum_bmv2.log</span></code>.</li>
<li>If here and still not working, <strong>reach out to one of the instructors for
assistance.</strong></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="EXERCISE-6.html" class="btn btn-neutral float-right" title="Exercise 6: Segment Routing v6 (SRv6)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="EXERCISE-4.html" class="btn btn-neutral float-left" title="Exercise 4: Enabling ONOS built-in services" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
